apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: hello-web
  namespace: argocd
spec:
  # Go templates are recommended and give you safer/stronger templating than legacy fasttemplate.
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    # -----------------------------
    # 1) FOLDER-BASED DISCOVERY
    # -----------------------------
    # This Git directory generator scans *directories* in gitops-repo under apps/*/{dev,staging,prod}.
    # When you add a new folder (e.g., apps/foo/dev), ArgoCD automatically creates a new Application.
    - git:
        repoURL: https://github.com/ido83/gitops-appset-demo-charts.git
        revision: master
        directories:
          - path: apps/*/dev
          - path: apps/*/staging
          - path: apps/*/prod
        # We map path segments into a stable set of values.* fields so the template is DRY.
        # path.segments for apps/<app>/<env>:
        #   index 0 = "apps"
        #   index 1 = "<app>"
        #   index 2 = "<env>"
        values:
          app: "{{ index .path.segments 1 }}"
          env: "{{ index .path.segments 2 }}"
          appName: "{{ index .path.segments 1 }}-{{ index .path.segments 2 }}"
          namespace: "{{ index .path.segments 1 }}-{{ index .path.segments 2 }}"
          valuesFile: "$values/apps/{{ index .path.segments 1 }}/{{ index .path.segments 2 }}/values.yaml"
          isPreview: "false"
          # Keep these keys defined for both generators to satisfy missingkey=error.
          prNumber: ""
          prBranch: ""
          prHeadShortSHA: ""
          ingressHost: ""

    # ---------------------------------------
    # 2) BRANCH/PR-BASED DISCOVERY (EPHEMERAL)
    # ---------------------------------------
    # ArgoCD's Pull Request generator discovers open PRs and exposes the PR *head branch* + SHAs
    # (e.g., .branch, .head_short_sha). This is the recommended way to build ephemeral environments
    # that track PR branches and clean up when PRs close.
    #
    # IMPORTANT SECURITY NOTE:
    # PR generators have security implications; restrict who can create ApplicationSets and PRs.
    - pullRequest:
        requeueAfterSeconds: 300
        github:
          owner: example-org
          repo: app-repo
          # Optional: require a "preview" label so not every PR spawns an environment.
          labels:
            - preview
          tokenRef:
            secretName: github-token
            key: token

        # values.* keeps the template identical across both discovery methods (DRY).
        values:
          app: "hello-web"
          env: "preview"
          appName: "hello-web-pr-{{ .number }}-{{ .branch_slug }}"
          namespace: "pr-{{ .number }}-{{ .branch_slug }}"
          valuesFile: "$values/apps/hello-web/preview/values.yaml"
          isPreview: "true"
          prNumber: "{{ .number }}"
          prBranch: "{{ .branch }}"
          prHeadShortSHA: "{{ .head_short_sha }}"
          # Put PR host pattern here so Helm can render a unique URL per PR.
          ingressHost: "hello-web-pr-{{ .number }}-{{ .branch_slug }}.example.local"

  template:
    metadata:
      name: "{{ .values.appName }}"
      labels:
        app.kubernetes.io/name: "{{ .values.app }}"
        app.kubernetes.io/instance: "{{ .values.appName }}"
        app.kubernetes.io/managed-by: "argocd-applicationset"
        env: "{{ .values.env }}"
    spec:
      project: platform
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{ .values.namespace }}"

      # Multi-source Application:
      # - Source[0] is the Helm chart (generic)
      # - Source[1] provides values files via ref: values ($values/...)
      # This is DRY: chart is reused; env values live in apps/<app>/<env>/values.yaml.
      sources:
        - repoURL: https://github.com/ido83/gitops-appset-demo-charts.git
          targetRevision: master
          path: charts/generic-app
          helm:
            releaseName: "{{ .values.app }}"
            valueFiles:
              - "{{ .values.valuesFile }}"

            # values (string) lets ApplicationSet inject dynamic per-generator overrides without
            # duplicating whole values files (especially important for PR previews).
            # Must use `values` (not `valuesObject`) so kubectl stores it as a raw string and
            # ArgoCD's Go template engine processes the {{- if }} blocks without YAML parse errors.
            values: |
              appMetadata:
                generatedBy: "applicationset"
                env: "{{ .values.env }}"
                prNumber: "{{ .values.prNumber }}"
                prBranch: "{{ .values.prBranch }}"
                prHeadShortSHA: "{{ .values.prHeadShortSHA }}"
              {{- if eq .values.isPreview "true" }}
              image:
                tag: "{{ .values.prHeadShortSHA }}"
              ingress:
                enabled: true
                hosts:
                  - host: "{{ .values.ingressHost }}"
                    paths:
                      - path: /
                        pathType: Prefix
              {{- end }}

        - repoURL: https://github.com/ido83/gitops-appset-demo-app.git
          targetRevision: master
          ref: values

      syncPolicy:
        automated:
          prune: true      # Remove resources no longer in Git (prevents drift).
          selfHeal: true   # Reconcile manual changes back to Git state.
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
